<!DOCTYPE html>
<html>
<head>
<title>When Did They Live?</title>
<meta name="description" content="">
<style>
  .axis path,
  .axis line {
      fill: none;
      stroke: black;
      shape-rendering: crispEdges;
  }

  .axis text {
      font-family: sans-serif;
      font-size: 11px;
  }

  .bar {
    fill: red;
    fill-opacity: 0.5;
  }

/*  #search_div, #timeline_div {
    margin: 0 auto;
    width: 80%;
  }*/

  #search_div {
    margin-top: 10px;
    margin-bottom: 20px;
  }

  svg, input {
    display: block;
    margin: 0 auto;
  }

</style>
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
    <script src="./jquery-ui-1.9.2.custom/js/jquery-1.8.3.js"></script>
    <script src="./jquery-ui-1.9.2.custom/js/jquery-ui-1.9.2.custom.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
  <script type="text/javascript">

var cache = new Array();

var canvasWidth = 1000;
var canvasHeight = 618;
var sideMargin = 20;
var timeScale;
var svg;
var numLivesPlotted = 0;
var xAxis;
var minYear = 1700;
var maxYear = 1800;
var format;

function createCanvas () {

  format = d3.format("0d");

  timeScale = d3.scale.linear()
    .domain([minYear, maxYear])
    .range([sideMargin, canvasWidth - sideMargin]);

  svg = d3.select("#timeline_div").append("svg:svg")
    .attr("id", "timeline")
    .attr("width", canvasWidth)
    .attr("height", canvasHeight);

  // svg.append("rect")
  //   .style("fill", "#EFF0F1")
  //   .attr("width", "100%")
  //   .attr("height", "100%");

  svg.append("g")
    .attr("id", "bars");

  // xAxis = d3.svg.axis()
  //   .scale(timeScale)
  //   .orient("top");

  // canvas.append("g")
  //   .call(xAxis);


  xAxis = svg.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(0," + 20 + ")")
    .call(d3.svg.axis()
                .scale(timeScale)
                .tickFormat(format)
                .orient("top"));
    

}


function addLifespan (name, years) {
  
  var birth = years.birth;
  var death = years.death;
  var delay = 0; // delay in adding new bar (0 unless plot needs to be resized)

  // Widen axes as necessary to accomodate added lifespan
  if (birth < minYear || death > maxYear) {
    
    // 
    if (birth < minYear) {
      minYear = 50 * Math.floor(birth / 50);
    }
    if (death > maxYear) {
      maxYear = 50 * Math.ceil(death / 50);
    }
    
    timeScale = d3.scale.linear()
      .domain([minYear, maxYear])
      .range([sideMargin, canvasWidth - sideMargin]);
    xAxis.call(d3.svg.axis()
                .scale(timeScale)
                .tickFormat(format)
                .orient("top"));
    svg.select("#bars").selectAll(".bar").transition()
      .attr("x", function(d) {
        return(timeScale(d.birth));
      })
      .attr("width", function(d) {
        return(timeScale(d.death) - timeScale(d.birth));
      });

    delay = 250;
  }

  var birthX = timeScale(birth);
  var deathX = timeScale(death);

  var addedBar = svg.select("#bars").append("rect")
    .datum({"birth" : birth, "death" : death})
    .attr("class", "bar")
    .attr("x", birthX)
    .attr("y", 24 + 20 * numLivesPlotted)
    .attr("height", 10)
    .attr("width", 0)
    .style("fill", "black");

  addedBar.transition()
    .delay(delay)
    .duration(600)
    .attr("width", deathX - birthX);

  

  numLivesPlotted += 1;

  // alert(numLivesPlotted);
}

$(document).ready(function() {

  createCanvas();

   $( "#search_box" ).autocomplete({
    source: function( request, response ) {
      console.log( request );
      $.ajax({
        url: "http://lookup.dbpedia.org/api/search.asmx/PrefixSearch?QueryClass=Person&MaxHits=8&QueryString=" + request["term"],
        dataType: "xml",
        success: function( xmlResponse ) {
          response( ($( xmlResponse).find("Result") ).map(function() {
            var label = ($(this)).find("Label:first").text();
            var uri = ($(this)).find("URI:first").text();
            cache[label] = uri;
            return {
              value: label,
              id: uri
            };
          }));
        }
      });
    },
    minLength: 4
  });

  // $("#search_box").keypress(function (e) {
  //   if (e.which == 13) {
  //     submit(this.value);
  //     this.value = "";
  //     return false;
  //   }
  // });
  
});

function submit(value) {
  if (value in cache) {
    addLifespan(value, cache[value]);
    console.log(cache[value]);
  }
}

function convertYearToPixels (year) {
  return( (year - minYear) / (maxYear - minYear) * canvasWidth );
}

//onkeyup="suggest(this.value)

</script>

</head>
<body>
  
<div id="search_div" class="ui-helper-clearfix">
<!-- <form id="search_form" method="post"> -->
<input type="text" id="search_box"/>
<!-- </form> -->
</div>

<div id="timeline_div">
<!-- <canvas id="timeline"> -->
<!-- </canvas> -->
</div>
   
</body>
</html>